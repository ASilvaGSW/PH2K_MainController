<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POWER HOSE 2K - Production Report</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/production_report.css') }}">
</head>
<body>
    <div class="container-fluid min-vh-100 g-0">
        <!-- Sign Out Confirmation Modal -->
        <div class="modal fade" id="signOutModal" tabindex="-1" aria-labelledby="signOutModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title lang-text" id="signOutModalLabel" data-en="Confirm Sign Out" data-es="Confirmar Cierre de Sesión" data-jp="サインアウトの確認">Confirm Sign Out</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="lang-text" data-en="Are you sure you want to sign out?" data-es="¿Está seguro de que desea cerrar la sesión?" data-jp="サインアウトしてもよろしいですか？">Are you sure you want to sign out?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm lang-text" data-bs-dismiss="modal" data-en="Cancel" data-es="Cancelar" data-jp="キャンセル">Cancel</button>
                        <a href="{{ url_for('logout') }}" class="btn btn-primary btn-sm lang-text" data-en="Sign Out" data-es="Cerrar Sesión" data-jp="サインアウト">Sign Out</a>
                    </div>
                </div>
            </div>
        </div>
        
        <header class="header py-2 px-4 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('main') }}" class="back-button me-3">
                    <i class="bi bi-arrow-left"></i>
                    <span class="ms-2 lang-text" data-en="Back to Main Menu" data-es="Volver al Menú Principal" data-jp="メインメニューに戻る">Back to Main Menu</span>
                </a>
                <span class="breadcrumb-separator">›</span>
                <span class="ms-2 lang-text" data-en="Production Report" data-es="Informe de Producción" data-jp="生産レポート">Production Report</span>
            </div>
            <div class="d-flex align-items-center">
                <div class="language-selector me-4">
                    <a href="#" class="active" onclick="changeLanguage('en'); return false;">English</a>
                    <a href="#" class="ms-3" onclick="changeLanguage('es'); return false;">Español</a>
                    <a href="#" class="ms-3" onclick="changeLanguage('jp'); return false;">日本語</a>
                </div>
                <div class="user-info d-flex align-items-center">
                    <div class="user-avatar me-2">
                        <div class="avatar-circle">
                            <i class="bi bi-person-fill"></i>
                        </div>
                    </div>
                    <div class="user-details">
                        <div class="operator-name">{{ username }}</div>
                        <a href="#" onclick="showSignOutModal(); return false;" class="sign-out lang-text" data-en="Sign Out" data-es="Cerrar Sesión" data-jp="サインアウト">Sign Out</a>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content p-4">
            <div class="d-flex align-items-center mb-4">
                <div class="me-3">
                    <div class="d-inline-block" style="background-color: #12B7F5; width: 8px; height: 30px; margin-right: 10px;"></div>
                </div>
                <h1 class="report-title lang-text" data-en="Production Report" data-es="Informe de Producción" data-jp="生産レポート">Production Report</h1>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle w-100 text-start" type="button" id="reportTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <span class="lang-text" data-en="Reporting Type" data-es="Tipo de Informe" data-jp="レポートタイプ">Reporting Type</span>
                        </button>
                        <ul class="dropdown-menu w-100" aria-labelledby="reportTypeDropdown">
                            <li><a class="dropdown-item" href="#">Type 1</a></li>
                            <li><a class="dropdown-item" href="#">Type 2</a></li>
                            <li><a class="dropdown-item" href="#">Type 3</a></li>
                        </ul>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle w-100 text-start" type="button" id="partNumberDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <span class="lang-text" data-en="Part Number List" data-es="Lista de Números de Parte" data-jp="部品番号リスト">Part Number List</span>
                        </button>
                        <ul class="dropdown-menu w-100" aria-labelledby="partNumberDropdown">
                            <li><a class="dropdown-item" href="#">All Parts</a></li>
                            {% for part_number in part_numbers %}
                            <li><a class="dropdown-item" href="#">{{ part_number }}</a></li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <h2 class="today-label lang-text" data-en="Today" data-es="Hoy" data-jp="今日">Today</h2>
                        <div class="date-navigation ms-4">
                            <button class="btn btn-light btn-sm rounded-circle me-2"><i class="bi bi-chevron-left"></i></button>
                            <button class="btn btn-light btn-sm rounded-circle"><i class="bi bi-chevron-right"></i></button>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle w-100 text-start" type="button" id="dateRangeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <span>{{ start_date.strftime('%B %d') }}-{{ end_date.strftime('%d, %Y') }}</span>
                        </button>
                        <ul class="dropdown-menu w-100" aria-labelledby="dateRangeDropdown">
                            <li><a class="dropdown-item" href="#">{{ start_date.strftime('%B %d') }}-{{ end_date.strftime('%d, %Y') }}</a></li>
                            <li><a class="dropdown-item" href="#">{{ (start_date - timedelta(days=7)).strftime('%B %d') }}-{{ (end_date - timedelta(days=7)).strftime('%d, %Y') }}</a></li>
                            <li><a class="dropdown-item" href="#">{{ (start_date + timedelta(days=7)).strftime('%B %d') }}-{{ (end_date + timedelta(days=7)).strftime('%d, %Y') }}</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-7">
                    <div class="schedule-container">
                        <div class="schedule-header">
                            {% for i in range(7) %}
                            {% set day = start_date + timedelta(days=i) %}
                            <div class="day-header">{{ day.strftime('%a').upper() }}<br>{{ day.strftime('%d') }}</div>
                            {% endfor %}
                        </div>
                        <div class="schedule-body">
                            <div class="time-column">
                                <div class="time-slot">9 AM</div>
                                <div class="time-slot">10 AM</div>
                                <div class="time-slot">11 AM</div>
                                <div class="time-slot">12 PM</div>
                                <div class="time-slot">1 PM</div>
                                <div class="time-slot">2 PM</div>
                                <div class="time-slot">3 PM</div>
                                <div class="time-slot">4 PM</div>
                                <div class="time-slot">5 PM</div>
                            </div>
                            <div class="schedule-grid">
                                <!-- Dynamic scheduled items from database -->
                                {% for item in production_data %}
                                    {% set day_index = ((item.date - start_date).days + 1) %}
                                    {% set hour = item.timestamp.hour %}
                                    {% set row_index = hour - 8 if hour >= 9 else 1 %}
                                    <div class="schedule-item" style="grid-row: {{ row_index }} / {{ row_index + 1 }}; grid-column: {{ day_index }};" 
                                         title="{{ item.part_number }} - {{ item.qty }} units - {{ item.user }}">
                                        {{ item.part_number }}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="report-tabs mb-3">
                        <button class="btn btn-primary me-2 lang-text" data-en="BOM" data-es="BOM" data-jp="部品表">BOM</button>
                        <button class="btn btn-light lang-text" data-en="TOOLING" data-es="HERRAMIENTAS" data-jp="工具">TOOLING</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th class="lang-text" data-en="Part Number/Tool" data-es="Número de Parte/Herramienta" data-jp="部品番号/工具">Part Number/Tool</th>
                                    <th class="lang-text" data-en="Desc" data-es="Desc" data-jp="説明">Desc</th>
                                    <th class="lang-text" data-en="Qty" data-es="Cant" data-jp="数量">Qty</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set unique_parts = {} %}
                                {% for item in production_data %}
                                    {% if item.part_number not in unique_parts %}
                                        {% set _ = unique_parts.update({item.part_number: {'qty': item.qty, 'machine': item.machine}}) %}
                                    {% else %}
                                        {% set _ = unique_parts.update({item.part_number: {'qty': unique_parts[item.part_number]['qty'] + item.qty, 'machine': unique_parts[item.part_number]['machine']}}) %}
                                    {% endif %}
                                {% endfor %}
                                
                                {% for part_number, data in unique_parts.items() %}
                                <tr>
                                    <td>{{ part_number }}</td>
                                    <td>{{ data.machine }}</td>
                                    <td>{{ data.qty }}</td>
                                </tr>
                                {% endfor %}
                                
                                {% if unique_parts|length == 0 %}
                                <tr>
                                    <td colspan="3" class="text-center">No production data available for this period</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function changeLanguage(lang) {
            // Update active class on language selector
            document.querySelectorAll('.language-selector a').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`.language-selector a[onclick*="'${lang}'"]`).classList.add('active');
            
            // Update all language elements
            document.querySelectorAll('.lang-text').forEach(el => {
                if (el.dataset[lang]) {
                    el.textContent = el.dataset[lang];
                }
            });
            
            // Save language preference to database via AJAX
            fetch('/set_language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ language: lang }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Language preference saved:', data);
            })
            .catch(error => {
                console.error('Error saving language preference:', error);
            });
        }
        
        function showSignOutModal() {
            // Initialize and show the sign out confirmation modal
            const signOutModal = new bootstrap.Modal(document.getElementById('signOutModal'));
            signOutModal.show();
        }
        
        // Load initial language preference from server
        document.addEventListener('DOMContentLoaded', function() {
            // Use the language passed from the server
            const initialLanguage = '{{ language }}';
            changeLanguage(initialLanguage);
        });
    </script>
</body>
</html>