<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POWER HOSE 2K - Tooling Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        .tooling-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .btn-action {
            padding: 5px 10px;
            margin: 2px;
            border-radius: 5px;
            font-size: 12px;
        }
        
        .status-active {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-inactive {
            color: #dc3545;
            font-weight: bold;
        }
        
        .search-box {
            border-radius: 25px;
            border: 2px solid #e9ecef;
            padding: 10px 20px;
        }
        
        .search-box:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
    </style>
</head>
<body>
    <div class="container-fluid min-vh-100 g-0">
        <!-- Sign Out Confirmation Modal -->
        <div class="modal fade" id="signOutModal" tabindex="-1" aria-labelledby="signOutModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title lang-text" id="signOutModalLabel" data-en="Confirm Sign Out" data-es="Confirmar Cierre de Sesión" data-jp="サインアウトの確認">Confirm Sign Out</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="lang-text" data-en="Are you sure you want to sign out?" data-es="¿Está seguro de que desea cerrar la sesión?" data-jp="サインアウトしてもよろしいですか？">Are you sure you want to sign out?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm lang-text" data-bs-dismiss="modal" data-en="Cancel" data-es="Cancelar" data-jp="キャンセル">Cancel</button>
                        <a href="{{ url_for('logout') }}" class="btn btn-primary btn-sm lang-text" data-en="Sign Out" data-es="Cerrar Sesión" data-jp="サインアウト">Sign Out</a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tool Form Modal -->
        <div class="modal fade" id="toolModal" tabindex="-1" aria-labelledby="toolModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title lang-text" id="toolModalLabel" data-en="Add/Edit Tool" data-es="Agregar/Editar Herramienta" data-jp="工具追加/編集">Add/Edit Tool</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="toolForm">
                            <input type="hidden" id="toolId" name="toolId">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="partNumberSelect" class="form-label lang-text" data-en="Part Number" data-es="Número de Parte" data-jp="部品番号">Part Number</label>
                                        <select class="form-select" id="partNumberSelect" name="partNumberId" required>
                                            <option value="" class="lang-text" data-en="-- Select Part Number --" data-es="-- Seleccionar Número de Parte --" data-jp="-- 部品番号を選択 --">-- Select Part Number --</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="toolNumber" class="form-label lang-text" data-en="Tool Number" data-es="Número de Herramienta" data-jp="工具番号">Tool Number</label>
                                        <input type="text" class="form-control" id="toolNumber" name="toolNumber" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="toolType" class="form-label lang-text" data-en="Tool Type" data-es="Tipo de Herramienta" data-jp="工具タイプ">Tool Type</label>
                                        <select class="form-select" id="toolType" name="toolType" required>
                                            <option value="cutting" class="lang-text" data-en="Cutting" data-es="Corte" data-jp="切削">Cutting</option>
                                            <option value="forming" class="lang-text" data-en="Forming" data-es="Formado" data-jp="成形">Forming</option>
                                            <option value="assembly" class="lang-text" data-en="Assembly" data-es="Ensamble" data-jp="組立">Assembly</option>
                                            <option value="inspection" class="lang-text" data-en="Inspection" data-es="Inspección" data-jp="検査">Inspection</option>
                                            <option value="other" class="lang-text" data-en="Other" data-es="Otro" data-jp="その他">Other</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="quantity" class="form-label lang-text" data-en="Quantity" data-es="Cantidad" data-jp="数量">Quantity</label>
                                        <input type="number" class="form-control" id="quantity" name="quantity" min="1" value="1" required>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="description" class="form-label lang-text" data-en="Description" data-es="Descripción" data-jp="説明">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary lang-text" data-bs-dismiss="modal" data-en="Cancel" data-es="Cancelar" data-jp="キャンセル">Cancel</button>
                        <button type="button" class="btn btn-primary lang-text" onclick="saveTool()" data-en="Save" data-es="Guardar" data-jp="保存">Save</button>
                    </div>
                </div>
            </div>
        </div>
        
        <header class="header py-2 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center" style="padding-left: 10px;">
                <a href="{{ url_for('engineering') }}" class="back-button me-3">
                    <i class="bi bi-arrow-left"></i>
                    <span class="ms-2 lang-text" data-en="Back to Engineering" data-es="Volver a Ingeniería" data-jp="エンジニアリングに戻る">Back to Engineering</span>
                </a>
                <span class="breadcrumb-separator">›</span>
                <span class="ms-2 lang-text" data-en="Tooling Management" data-es="Gestión de Herramientas" data-jp="工具管理">Tooling Management</span>
            </div>
            <div class="d-flex align-items-center">
                <div class="language-selector me-4">
                    <a href="#" class="active" onclick="changeLanguage('en'); return false;">English</a>
                    <a href="#" class="ms-3" onclick="changeLanguage('es'); return false;">Español</a>
                    <a href="#" class="ms-3" onclick="changeLanguage('jp'); return false;">日本語</a>
                </div>
                <div class="user-info d-flex align-items-center" style="padding-right: 10px;">
                    <div class="user-avatar me-2">
                        <div class="avatar-circle">
                            <i class="bi bi-person-fill"></i>
                        </div>
                    </div>
                    <div class="user-details">
                        <div class="operator-name">{{ username }}</div>
                        <a href="#" onclick="showSignOutModal(); return false;" class="sign-out lang-text" data-en="Sign Out" data-es="Cerrar Sesión" data-jp="サインアウト">Sign Out</a>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content p-4">
            <div class="d-flex align-items-center mb-4">
                <div class="me-3">
                    <div class="d-inline-block" style="background-color: #12B7F5; width: 8px; height: 30px; margin-right: 10px;"></div>
                </div>
                <h1 class="tooling-title lang-text" data-en="Tooling Management" data-es="Gestión de Herramientas" data-jp="工具管理">Tooling Management</h1>
            </div>
            
            <div class="tooling-container">
                <!-- Controls Section -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="showAddToolModal()">
                                <i class="bi bi-plus-circle"></i>
                                <span class="lang-text" data-en="Add Tool" data-es="Agregar Herramienta" data-jp="工具追加">Add Tool</span>
                            </button>
                            <button class="btn btn-success" onclick="loadTools()">
                                <i class="bi bi-arrow-clockwise"></i>
                                <span class="lang-text" data-en="Refresh" data-es="Actualizar" data-jp="更新">Refresh</span>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control search-box" id="searchInput" placeholder="Search tools..." onkeyup="filterTools()">
                            <select class="form-select" id="partNumberFilter" onchange="filterTools()" style="max-width: 200px;">
                                <option value="" class="lang-text" data-en="All Part Numbers" data-es="Todos los Números de Parte" data-jp="全部品番号">All Part Numbers</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Tools Table -->
                <div class="table-container">
                    <table class="table table-hover mb-0" id="toolsTable">
                        <thead class="table-light">
                            <tr>
                                <th class="lang-text" data-en="Part Number" data-es="Número de Parte" data-jp="部品番号">Part Number</th>
                                <th class="lang-text" data-en="Tool Number" data-es="Número de Herramienta" data-jp="工具番号">Tool Number</th>
                                <th class="lang-text" data-en="Type" data-es="Tipo" data-jp="タイプ">Type</th>
                                <th class="lang-text" data-en="Description" data-es="Descripción" data-jp="説明">Description</th>
                                <th class="lang-text" data-en="Quantity" data-es="Cantidad" data-jp="数量">Quantity</th>
                                <th class="lang-text" data-en="Status" data-es="Estado" data-jp="状態">Status</th>
                                <th class="lang-text" data-en="Created" data-es="Creado" data-jp="作成日">Created</th>
                                <th class="lang-text" data-en="Actions" data-es="Acciones" data-jp="アクション">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="toolsTableBody">
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <div class="mt-2 lang-text" data-en="Loading tools..." data-es="Cargando herramientas..." data-jp="工具を読み込み中...">Loading tools...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentLanguage = 'en';
        let allTools = [];
        let allPartNumbers = [];
        
        function changeLanguage(lang) {
            currentLanguage = lang;
            document.querySelectorAll('.language-selector a').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`.language-selector a[onclick*="'${lang}'"]`).classList.add('active');
            
            document.querySelectorAll('.lang-text').forEach(el => {
                if (el.dataset[lang]) {
                    el.textContent = el.dataset[lang];
                }
            });
            
            fetch('/set_language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ language: lang }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Language preference saved:', data);
            })
            .catch(error => {
                console.error('Error saving language preference:', error);
            });
        }
        
        function showSignOutModal() {
            const signOutModal = new bootstrap.Modal(document.getElementById('signOutModal'));
            signOutModal.show();
        }
        
        function showAddToolModal() {
            document.getElementById('toolForm').reset();
            document.getElementById('toolId').value = '';
            const modal = new bootstrap.Modal(document.getElementById('toolModal'));
            modal.show();
        }
        
        function editTool(toolId) {
            const tool = allTools.find(t => t.id === toolId);
            if (tool) {
                document.getElementById('toolId').value = tool.id;
                document.getElementById('partNumberSelect').value = tool.part_number_id;
                document.getElementById('toolNumber').value = tool.tool_number;
                document.getElementById('toolType').value = tool.tool_type;
                document.getElementById('quantity').value = tool.quantity;
                document.getElementById('description').value = tool.description || '';
                
                const modal = new bootstrap.Modal(document.getElementById('toolModal'));
                modal.show();
            }
        }
        
        function saveTool() {
            const form = document.getElementById('toolForm');
            const toolId = document.getElementById('toolId').value;
            
            // Convert form data to JSON
            const formData = {
                part_number_id: parseInt(form.partNumberSelect.value),
                tool_number: form.toolNumber.value,
                tool_type: form.toolType.value,
                quantity: parseInt(form.quantity.value) || 1,
                description: form.description.value
            };
            
            const url = toolId ? `/update_tool/${toolId}` : '/create_tool';
            const method = 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('toolModal'));
                    modal.hide();
                    loadTools();
                    showAlert('success', data.message);
                } else {
                    showAlert('danger', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'An error occurred while saving the tool.');
            });
        }
        
        function toggleToolStatus(toolId) {
            const tool = allTools.find(t => t.id === toolId);
            const action = tool && tool.active ? 'deactivate' : 'activate';
            const confirmMessage = `Are you sure you want to ${action} this tool?`;
            
            if (confirm(confirmMessage)) {
                fetch(`/toggle_tool_status/${toolId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadTools();
                        showAlert('success', data.message);
                    } else {
                        showAlert('danger', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', 'An error occurred while updating tool status.');
                });
            }
        }
        
        function deleteTool(toolId) {
            if (confirm('Are you sure you want to delete this tool?')) {
                fetch(`/delete_tool/${toolId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadTools();
                        showAlert('success', data.message);
                    } else {
                        showAlert('danger', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', 'An error occurred while deleting the tool.');
                });
            }
        }
        
        function loadTools() {
            fetch('/get_tools')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allTools = data.tools;
                        displayTools(allTools);
                    } else {
                        showAlert('danger', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', 'An error occurred while loading tools.');
                });
        }
        
        function loadPartNumbers() {
            fetch('/get_part_numbers')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allPartNumbers = data.part_numbers;
                        populatePartNumberSelects();
                    }
                })
                .catch(error => {
                    console.error('Error loading part numbers:', error);
                });
        }
        
        function populatePartNumberSelects() {
            const modalSelect = document.getElementById('partNumberSelect');
            const filterSelect = document.getElementById('partNumberFilter');
            
            // Clear existing options (except first)
            modalSelect.innerHTML = '<option value="">-- Select Part Number --</option>';
            filterSelect.innerHTML = '<option value="">All Part Numbers</option>';
            
            allPartNumbers.forEach(pn => {
                const modalOption = new Option(pn.part_number, pn.id);
                const filterOption = new Option(pn.part_number, pn.id);
                modalSelect.appendChild(modalOption);
                filterSelect.appendChild(filterOption);
            });
        }
        
        function displayTools(tools) {
            const tbody = document.getElementById('toolsTableBody');
            
            if (tools.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No tools found.</td></tr>';
                return;
            }
            
            tbody.innerHTML = tools.map(tool => {
                const partNumber = allPartNumbers.find(pn => pn.id === tool.part_number_id);
                const statusClass = tool.active ? 'status-active' : 'status-inactive';
                const statusText = tool.active ? 'Active' : 'Inactive';
                const statusIcon = tool.active ? 'bi-check-circle' : 'bi-x-circle';
                
                return `
                    <tr>
                        <td>${partNumber ? partNumber.part_number : 'N/A'}</td>
                        <td>${tool.tool_number}</td>
                        <td><span class="badge bg-secondary">${tool.tool_type}</span></td>
                        <td>${tool.description || '-'}</td>
                        <td>${tool.quantity}</td>
                        <td><span class="${statusClass}"><i class="bi ${statusIcon}"></i> ${statusText}</span></td>
                        <td>${new Date(tool.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary btn-action" onclick="editTool(${tool.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-${tool.active ? 'warning' : 'success'} btn-action" onclick="toggleToolStatus(${tool.id})" title="${tool.active ? 'Deactivate' : 'Activate'}">
                                <i class="bi bi-${tool.active ? 'pause' : 'play'}"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger btn-action" onclick="deleteTool(${tool.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterTools() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const partNumberFilter = document.getElementById('partNumberFilter').value;
            
            let filteredTools = allTools.filter(tool => {
                const partNumber = allPartNumbers.find(pn => pn.id === tool.part_number_id);
                const partNumberText = partNumber ? partNumber.part_number.toLowerCase() : '';
                
                const matchesSearch = !searchTerm || 
                    tool.tool_number.toLowerCase().includes(searchTerm) ||
                    tool.tool_type.toLowerCase().includes(searchTerm) ||
                    (tool.description && tool.description.toLowerCase().includes(searchTerm)) ||
                    partNumberText.includes(searchTerm);
                
                const matchesPartNumber = !partNumberFilter || tool.part_number_id.toString() === partNumberFilter;
                
                return matchesSearch && matchesPartNumber;
            });
            
            displayTools(filteredTools);
        }
        
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            const initialLanguage = '{{ language }}';
            changeLanguage(initialLanguage);
            loadPartNumbers();
            loadTools();
        });
    </script>
</body>
</html>