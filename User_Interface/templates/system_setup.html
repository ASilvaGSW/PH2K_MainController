<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POWER HOSE 2K - System Setup</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        .table-responsive {
            margin-top: 20px;
        }
        .action-buttons .btn {
            margin-right: 5px;
        }
        .tab-content {
            padding: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container-fluid min-vh-100 g-0">
        <header class="header py-2 px-4 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('main') }}" class="back-button me-3">
                    <i class="bi bi-arrow-left"></i>
                    <span class="ms-2 lang-text" data-en="Back to Main Menu" data-es="Volver al Menú Principal" data-jp="メインメニューに戻る">Back to Main Menu</span>
                </a>
            </div>
            <div class="d-flex align-items-center">
                <div class="language-selector me-4">
                    <a href="#" class="active" onclick="changeLanguage('en'); return false;">English</a>
                    <a href="#" class="ms-3" onclick="changeLanguage('es'); return false;">Español</a>
                    <a href="#" class="ms-3" onclick="changeLanguage('jp'); return false;">日本語</a>
                </div>
                <div class="user-info d-flex align-items-center">
                    <div class="user-avatar me-2">
                        <div class="avatar-circle">
                            <i class="bi bi-person-fill"></i>
                        </div>
                    </div>
                    <div class="user-details">
                        <div class="operator-name">{{ username }}</div>
                        <a href="#" onclick="showSignOutModal(); return false;" class="sign-out lang-text" data-en="Sign Out" data-es="Cerrar Sesión" data-jp="サインアウト">Sign Out</a>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content p-4">
            <h1 class="main-title mb-4 lang-text" data-en="System Setup" data-es="Configuración del Sistema" data-jp="システム設定">System Setup</h1>
            
            <!-- Admin Only Warning -->
            {% if not is_admin %}
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <span class="lang-text" data-en="This section is restricted to administrators only." data-es="Esta sección está restringida solo para administradores." data-jp="このセクションは管理者のみに制限されています。">This section is restricted to administrators only.</span>
            </div>
            {% else %}
            
            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs" id="setupTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active lang-text" data-en="User Management" data-es="Gestión de Usuarios" data-jp="ユーザー管理" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab" aria-controls="users" aria-selected="true">User Management</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link lang-text" data-en="Database Management" data-es="Gestión de Base de Datos" data-jp="データベース管理" id="database-tab" data-bs-toggle="tab" data-bs-target="#database" type="button" role="tab" aria-controls="database" aria-selected="false">Database Management</button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="setupTabsContent">
                <!-- User Management Tab -->
                <div class="tab-pane fade show active" id="users" role="tabpanel" aria-labelledby="users-tab">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="lang-text" data-en="User Management" data-es="Gestión de Usuarios" data-jp="ユーザー管理">User Management</h3>
                        <button type="button" class="btn btn-sm btn-primary" style="width: 300px;" data-bs-toggle="modal" data-bs-target="#addUserModal">
                            <i class="bi bi-person-plus-fill me-1"></i>
                            <span class="lang-text" data-en="Add User" data-es="Añadir Usuario" data-jp="ユーザーを追加">Add User</span>
                        </button>
                    </div>
                    
                    <!-- Users Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th class="lang-text" data-en="ID" data-es="ID" data-jp="ID">ID</th>
                                    <th class="lang-text" data-en="Username" data-es="Nombre de Usuario" data-jp="ユーザー名">Username</th>
                                    <th class="lang-text" data-en="Badge ID" data-es="ID de Insignia" data-jp="バッジID">Badge ID</th>
                                    <th class="lang-text" data-en="Admin" data-es="Administrador" data-jp="管理者">Admin</th>
                                    <th class="lang-text" data-en="Actions" data-es="Acciones" data-jp="アクション">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>{{ user.id }}</td>
                                    <td>{{ user.username }}</td>
                                    <td>{{ user.badge_id }}</td>
                                    <td>
                                        {% if user.is_admin %}
                                        <i class="bi bi-check-circle-fill text-success"></i>
                                        {% else %}
                                        <i class="bi bi-x-circle text-danger"></i>
                                        {% endif %}
                                    </td>
                                    <td class="action-buttons">
                                        <button class="btn btn-sm btn-success edit-user" data-id="{{ user.id }}" data-username="{{ user.username }}" data-badge="{{ user.badge_id }}" data-admin="{{ user.is_admin }}" data-bs-toggle="modal" data-bs-target="#editUserModal">
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-user" data-id="{{ user.id }}" data-username="{{ user.username }}" data-bs-toggle="modal" data-bs-target="#deleteUserModal">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>
                                        <button class="btn btn-sm btn-warning reset-password" data-id="{{ user.id }}" data-username="{{ user.username }}" data-bs-toggle="modal" data-bs-target="#resetPasswordModal">
                                            <i class="bi bi-key-fill"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Database Management Tab -->
                <div class="tab-pane fade" id="database" role="tabpanel" aria-labelledby="database-tab">
                    <h3 class="mb-3 lang-text" data-en="Database Management" data-es="Gestión de Base de Datos" data-jp="データベース管理">Database Management</h3>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header lang-text" data-en="Database Backup" data-es="Copia de Seguridad de la Base de Datos" data-jp="データベースバックアップ">Database Backup</div>
                                <div class="card-body">
                                    <p class="lang-text" data-en="Create a backup of the current database." data-es="Crear una copia de seguridad de la base de datos actual." data-jp="現在のデータベースのバックアップを作成します。">Create a backup of the current database.</p>
                                    <button class="btn btn-sm btn-primary lang-text" data-en="Create Backup" data-es="Crear Copia de Seguridad" data-jp="バックアップを作成" id="backupBtn">Create Backup</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header lang-text" data-en="Database Restore" data-es="Restaurar Base de Datos" data-jp="データベース復元">Database Restore</div>
                                <div class="card-body">
                                    <p class="lang-text" data-en="Restore the database from a backup file." data-es="Restaurar la base de datos desde un archivo de copia de seguridad." data-jp="バックアップファイルからデータベースを復元します。">Restore the database from a backup file.</p>
                                    <form id="restoreForm" action="{{ url_for('restore_database') }}" method="post" enctype="multipart/form-data">
                                        <div class="mb-3">
                                            <input class="form-control" type="file" id="backupFile" name="backupFile" accept=".sql">
                                        </div>
                                        <button type="submit" class="btn btn-sm btn-warning lang-text" data-en="Restore Database" data-es="Restaurar Base de Datos" data-jp="データベースを復元">Restore Database</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </main>
    </div>
    
    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title lang-text" data-en="Add New User" data-es="Añadir Nuevo Usuario" data-jp="新しいユーザーを追加" id="addUserModalLabel">Add New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="addUserForm" action="{{ url_for('add_user') }}" method="post">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="newUsername" class="form-label lang-text" data-en="Username" data-es="Nombre de Usuario" data-jp="ユーザー名">Username</label>
                            <input type="text" class="form-control" id="newUsername" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label lang-text" data-en="Password" data-es="Contraseña" data-jp="パスワード">Password</label>
                            <input type="password" class="form-control" id="newPassword" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="newBadgeId" class="form-label lang-text" data-en="Badge ID" data-es="ID de Insignia" data-jp="バッジID">Badge ID</label>
                            <input type="text" class="form-control" id="newBadgeId" name="badge_id" required>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="newIsAdmin" name="is_admin">
                            <label class="form-check-label lang-text" data-en="Administrator" data-es="Administrador" data-jp="管理者" for="newIsAdmin">Administrator</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-secondary lang-text" data-en="Cancel" data-es="Cancelar" data-jp="キャンセル" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-sm btn-primary lang-text" data-en="Add User" data-es="Añadir Usuario" data-jp="ユーザーを追加">Add User</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title lang-text" data-en="Edit User" data-es="Editar Usuario" data-jp="ユーザーを編集" id="editUserModalLabel">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editUserForm" action="{{ url_for('edit_user') }}" method="post">
                    <div class="modal-body">
                        <input type="hidden" id="editUserId" name="user_id">
                        <div class="mb-3">
                            <label for="editUsername" class="form-label lang-text" data-en="Username" data-es="Nombre de Usuario" data-jp="ユーザー名">Username</label>
                            <input type="text" class="form-control" id="editUsername" name="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="editBadgeId" class="form-label lang-text" data-en="Badge ID" data-es="ID de Insignia" data-jp="バッジID">Badge ID</label>
                            <input type="text" class="form-control" id="editBadgeId" name="badge_id" required>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="editIsAdmin" name="is_admin">
                            <label class="form-check-label lang-text" data-en="Administrator" data-es="Administrador" data-jp="管理者" for="editIsAdmin">Administrator</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-secondary lang-text" data-en="Cancel" data-es="Cancelar" data-jp="キャンセル" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-sm btn-primary lang-text" data-en="Save Changes" data-es="Guardar Cambios" data-jp="変更を保存">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Delete User Modal -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title lang-text" data-en="Delete User" data-es="Eliminar Usuario" data-jp="ユーザーを削除" id="deleteUserModalLabel">Delete User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="deleteUserForm" action="{{ url_for('delete_user') }}" method="post">
                    <div class="modal-body">
                        <input type="hidden" id="deleteUserId" name="user_id">
                        <p class="lang-text" data-en="Are you sure you want to delete the user" data-es="¿Está seguro de que desea eliminar el usuario" data-jp="本当にユーザーを削除しますか">Are you sure you want to delete the user <strong id="deleteUsername"></strong>?</p>
                        <p class="text-danger lang-text" data-en="This action cannot be undone." data-es="Esta acción no se puede deshacer." data-jp="この操作は元に戻せません。">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-secondary lang-text" data-en="Cancel" data-es="Cancelar" data-jp="キャンセル" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-sm btn-danger lang-text" data-en="Delete" data-es="Eliminar" data-jp="削除">Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Reset Password Modal -->
    <div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title lang-text" data-en="Reset Password" data-es="Restablecer Contraseña" data-jp="パスワードをリセット" id="resetPasswordModalLabel">Reset Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="resetPasswordForm" action="{{ url_for('reset_password') }}" method="post">
                    <div class="modal-body">
                        <input type="hidden" id="resetUserId" name="user_id">
                        <p class="lang-text" data-en="Reset password for user" data-es="Restablecer contraseña para el usuario" data-jp="ユーザーのパスワードをリセット">Reset password for user <strong id="resetUsername"></strong></p>
                        <div class="mb-3">
                            <label for="newResetPassword" class="form-label lang-text" data-en="New Password" data-es="Nueva Contraseña" data-jp="新しいパスワード">New Password</label>
                            <input type="password" class="form-control" id="newResetPassword" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmResetPassword" class="form-label lang-text" data-en="Confirm Password" data-es="Confirmar Contraseña" data-jp="パスワードを確認">Confirm Password</label>
                            <input type="password" class="form-control" id="confirmResetPassword" required>
                            <div class="invalid-feedback lang-text" data-en="Passwords do not match" data-es="Las contraseñas no coinciden" data-jp="パスワードが一致しません">Passwords do not match</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-sm btn-secondary lang-text" data-en="Cancel" data-es="Cancelar" data-jp="キャンセル" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-sm btn-warning lang-text" data-en="Reset Password" data-es="Restablecer Contraseña" data-jp="パスワードをリセット">Reset Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Sign Out Confirmation Modal -->
    <div class="modal fade" id="signOutModal" tabindex="-1" aria-labelledby="signOutModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title lang-text" id="signOutModalLabel" data-en="Confirm Sign Out" data-es="Confirmar Cierre de Sesión" data-jp="サインアウトの確認">Confirm Sign Out</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="lang-text" data-en="Are you sure you want to sign out?" data-es="¿Está seguro de que desea cerrar la sesión?" data-jp="サインアウトしてもよろしいですか？">Are you sure you want to sign out?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-sm btn-secondary lang-text" data-en="Cancel" data-es="Cancelar" data-jp="キャンセル" data-bs-dismiss="modal">Cancel</button>
                    <a href="{{ url_for('logout') }}" class="btn btn-sm btn-primary lang-text" data-en="Sign Out" data-es="Cerrar Sesión" data-jp="サインアウト">Sign Out</a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function changeLanguage(lang) {
            // Update active class on language selector
            document.querySelectorAll('.language-selector a').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`.language-selector a[onclick*="'${lang}'"]`).classList.add('active');
            
            // Update all language elements
            document.querySelectorAll('.lang-text').forEach(el => {
                if (el.dataset[lang]) {
                    el.textContent = el.dataset[lang];
                }
            });
            
            // Save language preference to database via AJAX
            fetch('/set_language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ language: lang }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Language preference saved:', data);
            })
            .catch(error => {
                console.error('Error saving language preference:', error);
            });
        }
        
        function showSignOutModal() {
            // Initialize and show the sign out confirmation modal
            const signOutModal = new bootstrap.Modal(document.getElementById('signOutModal'));
            signOutModal.show();
        }
        
        // Load initial language preference from server
        document.addEventListener('DOMContentLoaded', function() {
            // Use the language passed from the server
            const initialLanguage = '{{ language }}';
            changeLanguage(initialLanguage);
            
            // Setup edit user modal
            document.querySelectorAll('.edit-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    const username = this.getAttribute('data-username');
                    const badgeId = this.getAttribute('data-badge');
                    const isAdmin = this.getAttribute('data-admin') === 'True';
                    
                    document.getElementById('editUserId').value = userId;
                    document.getElementById('editUsername').value = username;
                    document.getElementById('editBadgeId').value = badgeId;
                    document.getElementById('editIsAdmin').checked = isAdmin;
                });
            });
            
            // Setup delete user modal
            document.querySelectorAll('.delete-user').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    const username = this.getAttribute('data-username');
                    
                    document.getElementById('deleteUserId').value = userId;
                    document.getElementById('deleteUsername').textContent = username;
                });
            });
            
            // Setup reset password modal
            document.querySelectorAll('.reset-password').forEach(button => {
                button.addEventListener('click', function() {
                    const userId = this.getAttribute('data-id');
                    const username = this.getAttribute('data-username');
                    
                    document.getElementById('resetUserId').value = userId;
                    document.getElementById('resetUsername').textContent = username;
                });
            });
            
            // Password confirmation validation
            const resetPasswordForm = document.getElementById('resetPasswordForm');
            if (resetPasswordForm) {
                resetPasswordForm.addEventListener('submit', function(event) {
                    const password = document.getElementById('newResetPassword').value;
                    const confirmPassword = document.getElementById('confirmResetPassword').value;
                    
                    if (password !== confirmPassword) {
                        event.preventDefault();
                        document.getElementById('confirmResetPassword').classList.add('is-invalid');
                    } else {
                        document.getElementById('confirmResetPassword').classList.remove('is-invalid');
                    }
                });
            }
            
            // Database backup button
            const backupBtn = document.getElementById('backupBtn');
            if (backupBtn) {
                backupBtn.addEventListener('click', function() {
                    fetch('/backup_database')
                        .then(response => response.blob())
                        .then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = 'database_backup.sql';
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                        })
                        .catch(error => {
                            console.error('Error creating backup:', error);
                            alert('Error creating backup: ' + error);
                        });
                });
            }
        });
    </script>
</body>
</html>