<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POWER HOSE 2K - Device Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        .device-management-container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .breadcrumb-nav {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .breadcrumb-nav a {
            color: #6c757d;
            text-decoration: none;
        }
        .breadcrumb-nav a:hover {
            color: #12B7F5;
        }
        .page-title {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
        }
        .page-title::before {
            content: '';
            width: 8px;
            height: 30px;
            background-color: #12B7F5;
            margin-right: 15px;
        }
        .add-device-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .form-control, .form-select {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
        }
        .btn-add {
            background-color: #12B7F5;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            font-weight: bold;
        }
        .btn-add:hover {
            background-color: #0ea5e9;
            color: white;
        }
        .devices-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }
        .table th {
            background-color: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #2c3e50;
            padding: 15px;
        }
        .table td {
            border: none;
            padding: 15px;
            vertical-align: middle;
        }
        .table tbody tr {
            border-bottom: 1px solid #eee;
        }
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .protocol-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .protocol-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .protocol-item:last-child {
            margin-bottom: 0;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .status-done {
            background-color: #12B7F5;
        }
        .status-progress {
            background-color: #6c757d;
        }
        .play-btn {
            background-color: #12B7F5;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-left: auto;
        }
        .pause-btn {
            background-color: #6c757d;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-left: auto;
        }
    </style>
</head>
<body>
    <div class="container-fluid min-vh-100 g-0">
        <!-- Sign Out Confirmation Modal -->
        <div class="modal fade" id="signOutModal" tabindex="-1" aria-labelledby="signOutModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title lang-text" id="signOutModalLabel" data-en="Confirm Sign Out" data-es="Confirmar Cierre de Sesión" data-jp="サインアウトの確認">Confirm Sign Out</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="lang-text" data-en="Are you sure you want to sign out?" data-es="¿Está seguro de que desea cerrar la sesión?" data-jp="サインアウトしてもよろしいですか？">Are you sure you want to sign out?</p>
                    </div>
                    <div class="modal-footer">
                        <a href="{{ url_for('logout') }}" class="btn btn-primary btn-sm lang-text" data-en="Sign Out" data-es="Cerrar Sesión" data-jp="サインアウト">Sign Out</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Device Modal -->
        <div class="modal fade" id="editDeviceModal" tabindex="-1" aria-labelledby="editDeviceModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title lang-text" id="editDeviceModalLabel" data-en="Edit Device" data-es="Editar Dispositivo" data-jp="デバイスを編集">Edit Device</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editDeviceForm">
                            <input type="hidden" id="editDeviceId">
                            <div class="mb-3">
                                <label for="editDeviceName" class="form-label lang-text" data-en="Device Name" data-es="Nombre del Dispositivo" data-jp="デバイス名">Device Name</label>
                                <input type="text" class="form-control" id="editDeviceName" required>
                            </div>
                            <div class="mb-3">
                                <label for="editDeviceType" class="form-label lang-text" data-en="Device Type" data-es="Tipo de Dispositivo" data-jp="デバイスタイプ">Device Type</label>
                                <select class="form-select" id="editDeviceType" required>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="editDeviceCanbus" class="form-label lang-text" data-en="CAN Bus ID" data-es="ID CAN Bus" data-jp="CAN Bus ID">CAN Bus ID</label>
                                <input type="text" class="form-control" id="editDeviceCanbus" required>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="updateDevice()" class="lang-text" data-en="Update Device" data-es="Actualizar Dispositivo" data-jp="デバイスを更新">Update Device</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteModalLabel" class="lang-text" data-en="Confirm Delete" data-es="Confirmar Eliminación" data-jp="削除の確認">Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="lang-text" data-en="Are you sure you want to delete the device" data-es="¿Está seguro de que desea eliminar el dispositivo" data-jp="デバイスを削除してもよろしいですか">Are you sure you want to delete the device</p>
                        <strong id="deleteDeviceName"></strong>?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" class="lang-text" data-en="Cancel" data-es="Cancelar" data-jp="キャンセル">Cancel</button>
                        <button type="button" class="btn btn-danger" onclick="confirmDelete()" class="lang-text" data-en="Delete" data-es="Eliminar" data-jp="削除">Delete</button>
                    </div>
                </div>
            </div>
        </div>
        
        <header class="header py-2 px-4 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('engineering') }}" class="back-button me-3">
                    <i class="bi bi-arrow-left"></i>
                    <span class="ms-2 lang-text" data-en="Main Menu" data-es="Menú Principal" data-jp="メインメニュー">Main Menu</span>
                </a>
                <div class="breadcrumb-nav">
                    <a href="{{ url_for('engineering') }}" class="lang-text" data-en="Engineering" data-es="Ingeniería" data-jp="エンジニアリング">Engineering</a>
                    <span> > </span>
                    <span class="lang-text" data-en="Device Management" data-es="Gestión de Dispositivos" data-jp="デバイス管理">Device Management</span>
                </div>
            </div>
            <div class="d-flex align-items-center">
                <div class="language-selector me-4">
                    <a href="#" class="active" onclick="changeLanguage('en'); return false;">English</a>
                    <a href="#" class="ms-3" onclick="changeLanguage('es'); return false;">Español</a>
                    <a href="#" class="ms-3" onclick="changeLanguage('jp'); return false;">日本語</a>
                </div>
                <div class="user-info d-flex align-items-center">
                    <div class="user-avatar me-2">
                        <div class="avatar-circle">
                            <i class="bi bi-person-fill"></i>
                        </div>
                    </div>
                    <div class="user-details">
                        <div class="operator-name">{{ username }}</div>
                        <a href="#" onclick="showSignOutModal(); return false;" class="sign-out lang-text" data-en="Sign Out" data-es="Cerrar Sesión" data-jp="サインアウト">Sign Out</a>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content p-4">
            <div class="device-management-container">
                <h1 class="page-title lang-text" data-en="Device Management" data-es="Gestión de Dispositivos" data-jp="デバイス管理">Device Management</h1>
                
                <!-- Add/Update Device Section -->
                <div class="add-device-section">
                    <h5 class="mb-3 lang-text" data-en="Add New Device" data-es=" Agregar Nuevo Dispositivo" data-jp="デバイスの更新/追加">Add New Device</h5>
                    <form id="deviceForm">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="deviceName" placeholder="New Device" data-en-placeholder="New Device" data-es-placeholder="Nuevo Dispositivo" data-jp-placeholder="新しいデバイス">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="deviceType">
                                    <option value="" class="lang-text" data-en="Device Type" data-es="Tipo de Dispositivo" data-jp="デバイスタイプ">Device Type</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="deviceCanbus" placeholder="Device #ID" data-en-placeholder="Device #ID" data-es-placeholder="ID del Dispositivo" data-jp-placeholder="デバイス#ID">
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-add w-100" onclick="addDevice()">
                                    <span class="lang-text" data-en="ADD" data-es="AGREGAR" data-jp="追加">ADD</span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Devices Table -->
                <div class="devices-table">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th class="lang-text" data-en="List of Devices" data-es="Lista de Dispositivos" data-jp="デバイスリスト">List of Devices</th>
                                <th class="lang-text" data-en="Device Type" data-es="Tipo de Dispositivo" data-jp="デバイスタイプ">Device Type</th>
                                <th class="lang-text" data-en="#ID" data-es="#ID" data-jp="#ID">#ID</th>
                                <th class="lang-text" data-en="Action" data-es="Acción" data-jp="アクション">Action</th>
                            </tr>
                        </thead>
                        <tbody id="devicesTableBody">
                            {% for device in devices %}
                            <tr data-device-id="{{ device.id }}">
                                <td>{{ device.name }}</td>
                                <td>{{ device.device_type.name if device.device_type else 'Unknown' }}</td>
                                <td>{{ device.canbus_id }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-success me-1" onclick="showEditModal({{ device.id }}, '{{ device.name }}', '{{ device.device_type_id }}', '{{ device.canbus_id }})" title="Edit">
                                            <i class="bi bi-pencil-fill"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="showDeleteModal({{ device.id }}, '{{ device.name }})" title="Delete">
                                            <i class="bi bi-trash-fill"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <!-- Protocol Status Panel
        <div class="protocol-status">
            <div class="protocol-item">
                <div class="status-indicator status-done"></div>
                <span class="lang-text" data-en="Protocol Func #1" data-es="Función de Protocolo #1" data-jp="プロトコル機能#1">Protocol Func #1</span>
                <button class="play-btn ms-2">
                    <i class="bi bi-pause-fill"></i>
                </button>
            </div>
            <div class="protocol-item">
                <div class="status-indicator status-progress"></div>
                <span class="lang-text" data-en="Protocol Func #2" data-es="Función de Protocolo #2" data-jp="プロトコル機能#2">Protocol Func #2</span>
                <button class="pause-btn ms-2">
                    <i class="bi bi-play-fill"></i>
                </button>
            </div>
            <div class="protocol-item">
                <div class="status-indicator status-progress"></div>
                <span class="lang-text" data-en="Protocol Func #2" data-es="Función de Protocolo #2" data-jp="プロトコル機能#2">Protocol Func #2</span>
                <button class="pause-btn ms-2">
                    <i class="bi bi-play-fill"></i>
                </button>
            </div>
            <div class="protocol-item">
                <div class="status-indicator status-progress"></div>
                <span class="lang-text" data-en="Protocol Func #2" data-es="Función de Protocolo #2" data-jp="プロトコル機能#2">Protocol Func #2</span>
                <button class="pause-btn ms-2">
                    <i class="bi bi-play-fill"></i>
                </button>
            </div>
            <div class="protocol-item">
                <div class="status-indicator status-progress"></div>
                <span class="lang-text" data-en="Protocol Func #2" data-es="Función de Protocolo #2" data-jp="プロトコル機能#2">Protocol Func #2</span>
                <button class="pause-btn ms-2">
                    <i class="bi bi-play-fill"></i>
                </button>
            </div>
            <div class="protocol-item">
                <div class="status-indicator status-progress"></div>
                <span class="lang-text" data-en="Protocol Func #2" data-es="Función de Protocolo #2" data-jp="プロトコル機能#2">Protocol Func #2</span>
                <button class="pause-btn ms-2">
                    <i class="bi bi-play-fill"></i>
                </button>
            </div>
        </div> -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function changeLanguage(lang) {
            // Update active class on language selector
            document.querySelectorAll('.language-selector a').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`.language-selector a[onclick*="'${lang}'"]`).classList.add('active');
            
            // Update all language elements
            document.querySelectorAll('.lang-text').forEach(el => {
                if (el.dataset[lang]) {
                    el.textContent = el.dataset[lang];
                }
            });
            
            // Update placeholders
            document.querySelectorAll('[data-' + lang + '-placeholder]').forEach(el => {
                el.placeholder = el.dataset[lang + 'Placeholder'];
            });
            
            // Save language preference to database via AJAX
            fetch('/set_language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ language: lang }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Language preference saved:', data);
            })
            .catch(error => {
                console.error('Error saving language preference:', error);
            });
        }
        
        function showSignOutModal() {
            const signOutModal = new bootstrap.Modal(document.getElementById('signOutModal'));
            signOutModal.show();
        }
        
        function addDevice() {
            const name = document.getElementById('deviceName').value.trim();
            const typeId = document.getElementById('deviceType').value;
            const canbus = document.getElementById('deviceCanbus').value.trim();
            
            if (!name || !typeId || !canbus) {
                alert('Please fill in all fields');
                return;
            }
            
            fetch('/create_device', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    device_type_id: parseInt(typeId),
                    canbus_id: canbus
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Clear form
                    document.getElementById('deviceForm').reset();
                    // Reload page to show new device
                    location.reload();
                } else {
                    alert(data.message || 'Error creating device');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating device');
            });
        }
        
        let deviceToDelete = null;
        let deviceToEdit = null;
        
        function showDeleteModal(deviceId, deviceName) {
            deviceToDelete = deviceId;
            document.getElementById('deleteDeviceName').textContent = deviceName;
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }
        
        function confirmDelete() {
            if (!deviceToDelete) return;
            
            fetch(`/delete_device/${deviceToDelete}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove row from table
                    const row = document.querySelector(`tr[data-device-id="${deviceToDelete}"]`);
                    if (row) {
                        row.remove();
                    }
                    // Close modal
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                    deleteModal.hide();
                } else {
                    alert(data.message || 'Error deleting device');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error deleting device');
            })
            .finally(() => {
                deviceToDelete = null;
            });
        }
        
        function showEditModal(deviceId, deviceName, deviceTypeId, canbusId) {
            deviceToEdit = deviceId;
            document.getElementById('editDeviceName').value = deviceName;
            document.getElementById('editDeviceType').value = deviceTypeId;
            document.getElementById('editDeviceCanbus').value = canbusId;
            const editModal = new bootstrap.Modal(document.getElementById('editDeviceModal'));
            editModal.show();
        }
        
        function updateDevice() {
            if (!deviceToEdit) return;
            
            const name = document.getElementById('editDeviceName').value.trim();
            const typeId = document.getElementById('editDeviceType').value;
            const canbus = document.getElementById('editDeviceCanbus').value.trim();
            
            if (!name || !typeId || !canbus) {
                alert('Please fill in all fields');
                return;
            }
            
            fetch(`/update_device/${deviceToEdit}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    name: name,
                    device_type_id: parseInt(typeId),
                    canbus_id: canbus
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal and reload page
                    const editModal = bootstrap.Modal.getInstance(document.getElementById('editDeviceModal'));
                    editModal.hide();
                    location.reload();
                } else {
                    alert(data.message || 'Error updating device');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating device');
            })
            .finally(() => {
                deviceToEdit = null;
            });
        }
        
        // Load device types from server
        function loadDeviceTypes() {
            fetch('/get_device_types')
                .then(response => response.json())
                .then(data => {
                    const addDeviceTypeSelect = document.getElementById('deviceType');
                    const editDeviceTypeSelect = document.getElementById('editDeviceType');
                    
                    // Clear existing options (except the first placeholder)
                    addDeviceTypeSelect.innerHTML = '<option value="" class="lang-text" data-en="Device Type" data-es="Tipo de Dispositivo" data-jp="デバイスタイプ">Device Type</option>';
                    editDeviceTypeSelect.innerHTML = '';
                    
                    // Add device type options
                    data.forEach(deviceType => {
                        const addOption = document.createElement('option');
                        addOption.value = deviceType.id;
                        addOption.textContent = deviceType.name;
                        addDeviceTypeSelect.appendChild(addOption);
                        
                        const editOption = document.createElement('option');
                        editOption.value = deviceType.id;
                        editOption.textContent = deviceType.name;
                        editDeviceTypeSelect.appendChild(editOption);
                    });
                })
                .catch(error => {
                    console.error('Error loading device types:', error);
                });
        }
        
        // Load initial language preference from server
        document.addEventListener('DOMContentLoaded', function() {
            const initialLanguage = '{{ language }}';
            changeLanguage(initialLanguage);
            loadDeviceTypes();
        });
    </script>
</body>
</html>