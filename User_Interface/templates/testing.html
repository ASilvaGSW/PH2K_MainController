<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POWER HOSE 2K - Testing</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <div class="container-fluid min-vh-100 g-0">
        <!-- Header -->
        <header class="header py-2 px-4 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('main') }}" class="back-button me-3">
                    <div class="circle-button d-flex align-items-center justify-content-center">
                        <i class="bi bi-arrow-left"></i>
                    </div>
                    <span class="ms-2 lang-text" data-en="Testing" data-es="Pruebas" data-jp="テスト">Testing</span>
                </a>
            </div>
            <div class="d-flex align-items-center">
                <div class="language-selector me-4">
                    <a href="#" class="active" onclick="changeLanguage('en'); return false;">English</a>
                    <a href="#" class="ms-3" onclick="changeLanguage('es'); return false;">Español</a>
                    <a href="#" class="ms-3" onclick="changeLanguage('jp'); return false;">日本語</a>
                </div>
                <div class="user-info d-flex align-items-center">
                    <div class="user-avatar me-2">
                        <div class="avatar-circle">
                            <i class="bi bi-person-fill"></i>
                        </div>
                    </div>
                    <div class="user-details">
                        <div class="operator-name">{{ username }}</div>
                        <a href="{{ url_for('logout') }}" class="sign-out lang-text" data-en="Sign Out" data-es="Cerrar Sesión" data-jp="サインアウト">Sign Out</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content p-4">
            <h1 class="main-title mb-5 lang-text" data-en="Testing Dashboard" data-es="Panel de Pruebas" data-jp="テストダッシュボード">Testing Dashboard</h1>
            
            <!-- Small Utility Buttons -->
            <div class="row g-2 mb-3">
                <!-- Small Button: Check Canbus -->
                <div class="col-md-2 col-sm-3">
                    <button class="btn w-100 h-100" onclick="checkCanbus()" style="min-height: 60px;">
                        <div class="menu-card p-2">
                            <div class="icon-container mb-1" style="font-size: 1.2rem;">
                                <i class="bi bi-play-circle"></i>
                            </div>
                            <div class="card-title lang-text" data-en="Check Canbus" data-es="Comprobar Canbus" data-jp="キャンバスを確認" style="font-size: 0.75rem;">Check Canbus</div>
                        </div>
                    </button>
                </div>
                <!-- Small Button: Test Home -->
                <div class="col-md-2 col-sm-3">
                    <button class="btn w-100 h-100" onclick="testAction3()" style="min-height: 60px;">
                        <div class="menu-card p-2">
                            <div class="icon-container mb-1" style="font-size: 1.2rem;">
                                <i class="bi bi-house"></i>
                            </div>
                            <div class="card-title lang-text" data-en="Test Home" data-es="Prueba Inicio" data-jp="テストホーム" style="font-size: 0.75rem;">Test Home</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Action Buttons Grid -->
            <div class="row g-2">
                <!-- Button 1: Receive Material -->
                <div class="col-md-3 col-sm-6">
                    <button class="btn w-100 h-100" onclick="testAction1()" style="min-height: 100px;">
                        <div class="menu-card">
                            <div class="icon-container mb-2">
                                <i class="bi bi-box-seam"></i>
                            </div>
                            <div class="card-title lang-text" data-en="Receive Material" data-es="Recibir Material" data-jp="材料を受け取る" style="font-size: 0.85rem;">Receive Material</div>
                        </div>
                    </button>
                </div>

                <!-- Button 2: Feed Cassette -->
                <div class="col-md-3 col-sm-6">
                    <button class="btn w-100 h-100" onclick="testAction4()" style="min-height: 100px;">
                        <div class="menu-card">
                            <div class="icon-container mb-2">
                                <i class="bi bi-arrow-clockwise"></i>
                            </div>
                            <div class="card-title lang-text" data-en="Feed Cassette" data-es="Alimentar Casete" data-jp="カセット供給" style="font-size: 0.85rem;">Feed Cassette</div>
                        </div>
                    </button>
                </div>

                <!-- Button 3: Align Cassette -->
                <div class="col-md-3 col-sm-6">
                    <button class="btn w-100 h-100" onclick="testAction5()" style="min-height: 100px;">
                        <div class="menu-card">
                            <div class="icon-container mb-2">
                                <i class="bi bi-arrow-left-right"></i>
                            </div>
                            <div class="card-title lang-text" data-en="Align Cassette" data-es="Alinear Casete" data-jp="カセット整列" style="font-size: 0.85rem;">Align Cassette</div>
                        </div>
                    </button>
                </div>

                <!-- Button 4: Align Component -->
                <div class="col-md-3 col-sm-6">
                    <button class="btn w-100 h-100" onclick="testAction2()" style="min-height: 100px;">
                        <div class="menu-card">
                            <div class="icon-container mb-2">
                                <i class="bi bi-crosshair"></i>
                            </div>
                            <div class="card-title lang-text" data-en="Align Component" data-es="Alinear Componente" data-jp="コンポーネント整列" style="font-size: 0.85rem;">Align Component</div>
                        </div>
                    </button>
                </div>

                <!-- Button 5: Pick and Place -->
                <div class="col-md-3 col-sm-6">
                    <button class="btn w-100 h-100" onclick="testAction6()" style="min-height: 100px;">
                        <div class="menu-card">
                            <div class="icon-container mb-2">
                                <i class="bi bi-box-arrow-in-down"></i>
                            </div>
                            <div class="card-title lang-text" data-en="Pick and Place" data-es="Recoger y Colocar" data-jp="ピックアンドプレース" style="font-size: 0.85rem;">Pick and Place</div>
                        </div>
                    </button>
                </div>

                <!-- Button 6: One Cycle -->
                <div class="col-md-3 col-sm-6">
                    <button class="btn w-100 h-100" onclick="testAction8()" style="min-height: 100px;">
                        <div class="menu-card">
                            <div class="icon-container mb-2">
                                <i class="bi bi-database"></i>
                            </div>
                            <div class="card-title lang-text" data-en="One Cycle" data-es="Un Ciclo" data-jp="1サイクル" style="font-size: 0.85rem;">One Cycle</div>
                        </div>
                    </button>
                </div>

                <!-- Button 7: Deliver Hose -->
                <div class="col-md-3 col-sm-6">
                    <button class="btn w-100 h-100" onclick="testAction9()" style="min-height: 100px;">
                        <div class="menu-card">
                            <div class="icon-container mb-2">
                                <i class="bi bi-arrow-down-circle"></i>
                            </div>
                            <div class="card-title lang-text" data-en="Deliver Hose" data-es="Entregar Manguera" data-jp="ホース配送" style="font-size: 0.85rem;">Deliver Hose</div>
                        </div>
                    </button>
                </div>

                <!-- Button 8: Full Routine -->
                <div class="col-md-3 col-sm-6">
                    <button class="btn w-100 h-100" onclick="testAction10()" style="min-height: 100px;">
                        <div class="menu-card">
                            <div class="icon-container mb-2">
                                <i class="bi bi-list-check"></i>
                            </div>
                            <div class="card-title lang-text" data-en="Full Routine" data-es="Rutina Completa" data-jp="フルルーチン" style="font-size: 0.85rem;">Full Routine</div>
                        </div>
                    </button>
                </div>
            </div>
            
            <!-- Test Results Section -->
            <div class="row mt-5">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0 lang-text" data-en="Test Results" data-es="Resultados de Prueba" data-jp="テスト結果">Test Results</h5>
                        </div>
                        <div class="card-body">
                            <div id="testResults" class="bg-light p-3 rounded" style="height: 200px; font-family: monospace; white-space: pre-wrap; overflow-y: auto;">
                                <span class="text-muted lang-text" data-en="Test results will appear here..." data-es="Los resultados de las pruebas aparecerán aquí..." data-jp="テスト結果がここに表示されます...">Test results will appear here...</span>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-secondary" onclick="clearResults()">
                                    <i class="bi bi-trash"></i>
                                    <span class="lang-text" data-en="Clear Results" data-es="Limpiar Resultados" data-jp="結果をクリア">Clear Results</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .log-entry {
            padding: 8px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .log-info {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
        }
        .log-success {
            background-color: #e8f5e8;
            border-left: 4px solid #4caf50;
            color: #2e7d32;
        }
        .log-error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }
        .timestamp {
            color: #666;
            font-weight: bold;
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script>
        // Language management
        function changeLanguage(lang) {
            // Update active class on language selector
            document.querySelectorAll('.language-selector a').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`.language-selector a[onclick*="'${lang}'"]`).classList.add('active');
            
            // Update all language elements
            document.querySelectorAll('.lang-text').forEach(el => {
                if (el.dataset[lang]) {
                    el.textContent = el.dataset[lang];
                }
            });
            
            // Save language preference to database via AJAX
            fetch('/set_language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ language: lang }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Language preference saved:', data);
            })
            .catch(error => {
                console.error('Error saving language preference:', error);
            });
        }
        
        // Test result logging with enhanced styling
        function logResult(message, type = 'info') {
            const resultsDiv = document.getElementById('testResults');
            const timestamp = new Date().toLocaleTimeString();
            
            // Clear placeholder text on first log
            const currentContent = resultsDiv.textContent;
            if (currentContent.includes('Test results will appear here') || 
                currentContent.includes('Los resultados de las pruebas aparecerán aquí') ||
                currentContent.includes('テスト結果がここに表示されます')) {
                resultsDiv.innerHTML = '';
            }
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            
            // Insert new entries at the top instead of bottom
            resultsDiv.insertBefore(logEntry, resultsDiv.firstChild);
            
            // Auto-scroll to top to show newest entry
            setTimeout(() => {
                resultsDiv.scrollTop = 0;
            }, 100);
        }
        
        function clearResults() {
            const resultsDiv = document.getElementById('testResults');
            const currentLang = document.querySelector('.language-selector a.active').textContent;
            let placeholderText = 'Test results will appear here...';
            
            if (currentLang === 'Español') {
                placeholderText = 'Los resultados de las pruebas aparecerán aquí...';
            } else if (currentLang === '日本語') {
                placeholderText = 'テスト結果がここに表示されます...';
            }
            
            resultsDiv.innerHTML = `<span class="text-muted">${placeholderText}</span>`;
        }
        
        // Test action functions with backend API integration
        function checkCanbus() {
            const button = document.querySelector('button[onclick="checkCanbus()"]');
            button.disabled = true;
            
            // Show processing state
            const originalContent = button.innerHTML;
            button.innerHTML = '<div class="menu-card p-2"><div class="icon-container mb-1" style="font-size: 1.2rem;"><i class="bi bi-arrow-clockwise" style="animation: spin 1s linear infinite;"></i></div><div class="card-title" style="font-size: 0.75rem;">...</div></div>';
            
            fetch('/check_canbus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    logResult(`✓ ${data.message}`, 'success');
                } else {
                    logResult(`✗ Error: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                logResult(`✗ Network Error: ${error.message}`, 'error');
            })
            .finally(() => {
                button.disabled = false;
                button.innerHTML = originalContent;
            });
        }

        function testAction1() {
            testAction(1);
        }
        
        function testAction2() {
            testAction(2);
        }
        
        function testAction3() {
            testAction(3);
        }
        
        function testAction4() {
            testAction(4);
        }
        
        function testAction5() {
            testAction(5);
        }
        
        function testAction6() {
            testAction(6);
        }
        
        function testAction7() {
            testAction(7);
        }
        
        function testAction8() {
            testAction(8);
        }
        
        function testAction9() {
            testAction(9);
        }
        
        function testAction10() {
            testAction(10);
        }
        
        function testAction(actionNumber) {
            const timestamp = new Date().toLocaleString();
            const button = document.querySelector(`button[onclick="testAction${actionNumber}()"]`);
            
            // Disable ALL buttons during request
            const allButtons = document.querySelectorAll('button[onclick^="testAction"]');
            allButtons.forEach(btn => {
                btn.disabled = true;
            });
            
            // Show processing state on clicked button
            if (button) {
                const originalContent = button.innerHTML;
                button.innerHTML = '<div class="menu-card"><div class="icon-container mb-3"><i class="bi bi-arrow-clockwise" style="animation: spin 1s linear infinite;"></i></div><div class="card-title">Processing...</div></div>';
            }
            
            // Make AJAX call to backend
            fetch(`/api/test_action_${actionNumber}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    timestamp: timestamp,
                    action: actionNumber
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    logResult(`✓ ${data.message}`, 'success');
                    if (data.data && data.data.details) {
                        logResult(`  Details: ${data.data.details}`, 'info');
                    }
                } else {
                    logResult(`✗ Error: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                logResult(`✗ Network Error: ${error.message}`, 'error');
            })
            .finally(() => {
                // Re-enable ALL buttons and restore original content
                const allButtons = document.querySelectorAll('button[onclick^="testAction"]');
                allButtons.forEach(btn => {
                    btn.disabled = false;
                });
                
                if (button) {
                    // Restore original button content based on action number
                    const buttonContents = {
                        3: '<div class="menu-card p-2"><div class="icon-container mb-1" style="font-size: 1.2rem;"><i class="bi bi-house"></i></div><div class="card-title lang-text" data-en="Test Home" data-es="Prueba Inicio" data-jp="テストホーム" style="font-size: 0.75rem;">Test Home</div></div>',
                        1: '<div class="menu-card"><div class="icon-container mb-2"><i class="bi bi-box-seam"></i></div><div class="card-title lang-text" data-en="Receive Material" data-es="Recibir Material" data-jp="材料を受け取る" style="font-size: 0.85rem;">Receive Material</div></div>',
                        2: '<div class="menu-card"><div class="icon-container mb-2"><i class="bi bi-crosshair"></i></div><div class="card-title lang-text" data-en="Align Component" data-es="Alinear Componente" data-jp="コンポーネント整列" style="font-size: 0.85rem;">Align Component</div></div>',
                        4: '<div class="menu-card"><div class="icon-container mb-2"><i class="bi bi-arrow-clockwise"></i></div><div class="card-title lang-text" data-en="Feed Cassette" data-es="Alimentar Casete" data-jp="カセット供給" style="font-size: 0.85rem;">Feed Cassette</div></div>',
                        5: '<div class="menu-card"><div class="icon-container mb-2"><i class="bi bi-arrow-left-right"></i></div><div class="card-title lang-text" data-en="Align Cassette" data-es="Alinear Casete" data-jp="カセット整列" style="font-size: 0.85rem;">Align Cassette</div></div>',
                        6: '<div class="menu-card"><div class="icon-container mb-2"><i class="bi bi-box-arrow-in-down"></i></div><div class="card-title lang-text" data-en="Pick and Place" data-es="Recoger y Colocar" data-jp="ピックアンドプレース" style="font-size: 0.85rem;">Pick and Place</div></div>',
                        8: '<div class="menu-card"><div class="icon-container mb-2"><i class="bi bi-database"></i></div><div class="card-title lang-text" data-en="One Cycle" data-es="Un Ciclo" data-jp="1サイクル" style="font-size: 0.85rem;">One Cycle</div></div>',
                        9: '<div class="menu-card"><div class="icon-container mb-2"><i class="bi bi-arrow-down-circle"></i></div><div class="card-title lang-text" data-en="Deliver Hose" data-es="Entregar Manguera" data-jp="ホース配送" style="font-size: 0.85rem;">Deliver Hose</div></div>',
                        10: '<div class="menu-card"><div class="icon-container mb-2"><i class="bi bi-list-check"></i></div><div class="card-title lang-text" data-en="Full Routine" data-es="Rutina Completa" data-jp="フルルーチン" style="font-size: 0.85rem;">Full Routine</div></div>'
                    };
                    button.innerHTML = buttonContents[actionNumber] || `Action ${actionNumber}`;
                }
            });
        }
        
        // Load initial language preference from server
        document.addEventListener('DOMContentLoaded', function() {
            // Use the language passed from the server
            const initialLanguage = '{{ language }}';
            changeLanguage(initialLanguage);
        });
    </script>
</body>
</html>