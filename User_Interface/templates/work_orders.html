<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POWER HOSE 2K - Work Orders</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/engineering.css') }}">
</head>
<body>
    <div class="container-fluid min-vh-100 g-0">
        <!-- Sign Out Confirmation Modal -->
        <div class="modal fade" id="signOutModal" tabindex="-1" aria-labelledby="signOutModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title lang-text" id="signOutModalLabel" data-en="Confirm Sign Out" data-es="Confirmar Cierre de Sesión" data-jp="サインアウトの確認">Confirm Sign Out</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="lang-text" data-en="Are you sure you want to sign out?" data-es="¿Está seguro de que desea cerrar la sesión?" data-jp="サインアウトしてもよろしいですか？">Are you sure you want to sign out?</p>
                    </div>
                    <div class="modal-footer">
                        <a href="{{ url_for('logout') }}" class="btn btn-primary btn-sm lang-text" data-en="Sign Out" data-es="Cerrar Sesión" data-jp="サインアウト">Sign Out</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Work Order Modal -->
        <div class="modal fade" id="workOrderModal" tabindex="-1" aria-labelledby="workOrderModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="workOrderModalLabel">
                            <span class="lang-text" data-en="Create Work Order" data-es="Crear Orden de Trabajo" data-jp="作業指示書を作成">Create Work Order</span>
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="workOrderForm">
                            <input type="hidden" id="workOrderId" name="id">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="partNumber" class="form-label lang-text" data-en="Part Number" data-es="Número de Parte" data-jp="部品番号">Part Number</label>
                                    <select class="form-select" id="partNumber" name="part_number" required>
                                        <option value="" class="lang-text" data-en="Select Part Number" data-es="Seleccionar Número de Parte" data-jp="部品番号を選択">Select Part Number</option>
                                        {% for part in part_numbers %}
                                        <option value="{{ part.part_number }}">{{ part.part_number }} - {{ part.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="qty" class="form-label lang-text" data-en="Quantity" data-es="Cantidad" data-jp="数量">Quantity</label>
                                    <input type="number" class="form-control" id="qty" name="qty" min="1" required>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-6">
                                    <label for="balance" class="form-label lang-text" data-en="Balance" data-es="Saldo" data-jp="残高">Balance</label>
                                    <input type="number" class="form-control" id="balance" name="balance" min="0" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="type" class="form-label lang-text" data-en="Type" data-es="Tipo" data-jp="タイプ">Type</label>
                                    <select class="form-select" id="type" name="type" required>
                                        <option value="" class="lang-text" data-en="Select Type" data-es="Seleccionar Tipo" data-jp="タイプを選択">Select Type</option>
                                        <option value="kanban" class="lang-text" data-en="Kanban" data-es="Kanban" data-jp="かんばん">Kanban</option>
                                        <option value="service" class="lang-text" data-en="Service" data-es="Servicio" data-jp="サービス">Service</option>
                                    </select>
                                </div>
                            </div>

                        </form>
                    </div>
                    <div class="modal-footer">
                        <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> -->
                            <!-- <span class="lang-text" data-en="Cancel" data-es="Cancelar" data-jp="キャンセル">Cancel</span> -->
                        <!-- </button> -->
                        <button type="button" class="btn btn-primary" onclick="saveWorkOrder()">
                            <span class="lang-text" data-en="Save" data-es="Guardar" data-jp="保存">Save</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title lang-text" id="deleteModalLabel" data-en="Confirm Delete" data-es="Confirmar Eliminación" data-jp="削除の確認">Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p class="lang-text" data-en="Are you sure you want to delete this work order?" data-es="¿Está seguro de que desea eliminar esta orden de trabajo?" data-jp="この作業指示書を削除してもよろしいですか？">Are you sure you want to delete this work order?</p>
                        <p><strong id="deleteWorkOrderInfo"></strong></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <span class="lang-text" data-en="Cancel" data-es="Cancelar" data-jp="キャンセル">Cancel</span>
                        </button>
                        <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                            <span class="lang-text" data-en="Delete" data-es="Eliminar" data-jp="削除">Delete</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <header class="header py-2 px-4 d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('engineering') }}" class="back-button me-3">
                    <i class="bi bi-arrow-left"></i>
                    <span class="ms-2 lang-text" data-en="Back to Engineering" data-es="Volver a Ingeniería" data-jp="エンジニアリングに戻る">Back to Engineering</span>
                </a>
            </div>
            <div class="d-flex align-items-center">
                <div class="language-selector me-4">
                    <a href="#" class="active" onclick="changeLanguage('en'); return false;">English</a>
                    <a href="#" class="ms-3" onclick="changeLanguage('es'); return false;">Español</a>
                    <a href="#" class="ms-3" onclick="changeLanguage('jp'); return false;">日本語</a>
                </div>
                <div class="user-info d-flex align-items-center">
                    <div class="user-avatar me-2">
                        <div class="avatar-circle">
                            <i class="bi bi-person-fill"></i>
                        </div>
                    </div>
                    <div class="user-details">
                        <div class="operator-name">{{ username }}</div>
                        <a href="#" onclick="showSignOutModal(); return false;" class="sign-out lang-text" data-en="Sign Out" data-es="Cerrar Sesión" data-jp="サインアウト">Sign Out</a>
                    </div>
                </div>
            </div>
        </header>

        <main class="main-content p-4">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="d-inline-block" style="background-color: #12B7F5; width: 8px; height: 30px; margin-right: 10px;"></div>
                    </div>
                    <h1 class="engineering-title lang-text" data-en="Work Orders" data-es="Órdenes de Trabajo" data-jp="作業指示書">Work Orders</h1>
                </div>
                <button class="btn btn-success" onclick="openWorkOrderModal()">
                    <i class="bi bi-plus-circle me-2"></i>
                    <span class="lang-text" data-en="Create Work Order" data-es="Crear Orden de Trabajo" data-jp="作業指示書を作成">Create Work Order</span>
                </button>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th class="lang-text" data-en="ID" data-es="ID" data-jp="ID">ID</th>
                                    <th class="lang-text" data-en="Part Number" data-es="Número de Parte" data-jp="部品番号">Part Number</th>
                                    <th class="lang-text" data-en="Quantity" data-es="Cantidad" data-jp="数量">Quantity</th>
                                    <th class="lang-text" data-en="Balance" data-es="Saldo" data-jp="残高">Balance</th>
                                    <th class="lang-text" data-en="Type" data-es="Tipo" data-jp="タイプ">Type</th>
                                    <th class="lang-text" data-en="Status" data-es="Estado" data-jp="ステータス">Status</th>
                                    <th class="lang-text" data-en="Created" data-es="Creado" data-jp="作成日">Created</th>
                                    <th class="lang-text" data-en="User" data-es="Usuario" data-jp="ユーザー">User</th>
                                    <th class="lang-text" data-en="Actions" data-es="Acciones" data-jp="アクション">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="workOrdersTableBody">
                                {% for work_order in work_orders %}
                                <tr>
                                    <td>{{ work_order.id }}</td>
                                    <td>{{ work_order.part_number }}</td>
                                    <td>{{ work_order.qty }}</td>
                                    <td>{{ work_order.balance }}</td>
                                    <td>
                                        <span class="badge {% if work_order.type == 'kanban' %}bg-primary{% else %}bg-success{% endif %}">
                                            {{ work_order.type.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if work_order.balance == work_order.qty %}
                                            <span class="badge bg-success lang-text" data-en="Completed" data-es="Completado" data-jp="完了">Completed</span>
                                        {% elif work_order.started_time %}
                                            <span class="badge bg-warning lang-text" data-en="In Progress" data-es="En Progreso" data-jp="進行中">In Progress</span>
                                        {% else %}
                                            <span class="badge bg-secondary lang-text" data-en="Not Started" data-es="No Iniciado" data-jp="未開始">Not Started</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ work_order.created.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>{{ work_order.user }}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn btn-sm btn-success me-1" onclick="editWorkOrder({{ work_order.id }})" title="Edit">
                                                <i class="bi bi-pencil-fill"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteWorkOrder({{ work_order.id }}, '{{ work_order.part_number }}')" title="Delete">
                                                <i class="bi bi-trash-fill"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if not work_orders %}
                    <div class="text-center py-5">
                        <i class="bi bi-clipboard-x" style="font-size: 3rem; color: #6c757d;"></i>
                        <h4 class="mt-3 text-muted lang-text" data-en="No Work Orders Found" data-es="No se Encontraron Órdenes de Trabajo" data-jp="作業指示書が見つかりません">No Work Orders Found</h4>
                        <p class="text-muted lang-text" data-en="Click the 'Create Work Order' button to get started." data-es="Haga clic en el botón 'Crear Orden de Trabajo' para comenzar." data-jp="「作業指示書を作成」ボタンをクリックして開始してください。">Click the 'Create Work Order' button to get started.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentEditId = null;
        let deleteWorkOrderId = null;

        function changeLanguage(lang) {
            // Update active class on language selector
            document.querySelectorAll('.language-selector a').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelector(`.language-selector a[onclick*="'${lang}'"]`).classList.add('active');
            
            // Update all language elements
            document.querySelectorAll('.lang-text').forEach(el => {
                if (el.dataset[lang]) {
                    el.textContent = el.dataset[lang];
                }
            });
            
            // Save language preference to database via AJAX
            fetch('/set_language', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ language: lang }),
            })
            .then(response => response.json())
            .then(data => {
                console.log('Language preference saved:', data);
            })
            .catch(error => {
                console.error('Error saving language preference:', error);
            });
        }
        
        function showSignOutModal() {
            const signOutModal = new bootstrap.Modal(document.getElementById('signOutModal'));
            signOutModal.show();
        }

        function openWorkOrderModal(editId = null) {
            currentEditId = editId;
            const modal = new bootstrap.Modal(document.getElementById('workOrderModal'));
            const form = document.getElementById('workOrderForm');
            const modalTitle = document.querySelector('#workOrderModalLabel .lang-text');
            
            if (editId) {
                // Edit mode
                modalTitle.textContent = modalTitle.dataset[getCurrentLanguage()] || 'Edit Work Order';
                modalTitle.setAttribute('data-en', 'Edit Work Order');
                modalTitle.setAttribute('data-es', 'Editar Orden de Trabajo');
                modalTitle.setAttribute('data-jp', '作業指示書を編集');
                
                // Load work order data
                fetch(`/get_work_order/${editId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const workOrder = data.work_order;
                            document.getElementById('workOrderId').value = workOrder.id;
                            document.getElementById('partNumber').value = workOrder.part_number;
                            document.getElementById('qty').value = workOrder.qty;
                            document.getElementById('balance').value = workOrder.balance;
                            document.getElementById('type').value = workOrder.type;
                            

                        }
                    })
                    .catch(error => console.error('Error loading work order:', error));
            } else {
                // Create mode
                modalTitle.textContent = modalTitle.dataset[getCurrentLanguage()] || 'Create Work Order';
                modalTitle.setAttribute('data-en', 'Create Work Order');
                modalTitle.setAttribute('data-es', 'Crear Orden de Trabajo');
                modalTitle.setAttribute('data-jp', '作業指示書を作成');
                form.reset();
                document.getElementById('workOrderId').value = '';
            }
            
            modal.show();
        }

        function saveWorkOrder() {
            const form = document.getElementById('workOrderForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            const url = currentEditId ? `/update_work_order/${currentEditId}` : '/create_work_order';
            const method = 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Error saving work order');
                }
            })
            .catch(error => {
                console.error('Error saving work order:', error);
                alert('Error saving work order');
            });
        }

        function editWorkOrder(id) {
            openWorkOrderModal(id);
        }

        function deleteWorkOrder(id, partNumber) {
            deleteWorkOrderId = id;
            document.getElementById('deleteWorkOrderInfo').textContent = `Work Order #${id} - ${partNumber}`;
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }

        function confirmDelete() {
            if (deleteWorkOrderId) {
                fetch(`/delete_work_order/${deleteWorkOrderId}`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert(data.message || 'Error deleting work order');
                    }
                })
                .catch(error => {
                    console.error('Error deleting work order:', error);
                    alert('Error deleting work order');
                });
            }
        }

        function getCurrentLanguage() {
            const activeLink = document.querySelector('.language-selector a.active');
            if (activeLink) {
                const onclick = activeLink.getAttribute('onclick');
                const match = onclick.match(/'([^']+)'/);
                return match ? match[1] : 'en';
            }
            return 'en';
        }
        
        // Load initial language preference from server
        document.addEventListener('DOMContentLoaded', function() {
            const initialLanguage = '{{ language }}';
            changeLanguage(initialLanguage);
        });
    </script>
</body>
</html>